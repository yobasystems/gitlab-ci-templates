variables:
  AST_ENABLE_MR_PIPELINES: "true"
  CS_ANALYZER_IMAGE: "$CI_TEMPLATE_REGISTRY_HOST/security-products/container-scanning:8"
  CS_SCHEMA_MODEL: 15

.container_scanning_template: &container_scanning_definition
  image: "$CS_ANALYZER_IMAGE$CS_IMAGE_SUFFIX"
  stage: test
  variables:
    GIT_STRATEGY: none
  allow_failure: true
  artifacts:
    access: 'developer'
    reports:
      container_scanning: "gl-container-scanning-report.json"
      cyclonedx: "**/gl-sbom-*.cdx.json"
    paths: [gl-container-scanning-report.json, "**/gl-sbom-*.cdx.json"]
  script:
    - if [ -z "${CS_IMAGE}" ]; then export CS_IMAGE="${CI_REGISTRY_IMAGE}:${ARCH}"; else export CS_IMAGE="${CS_IMAGE}-${ARCH}"; fi
    - gtcs scan
  rules:
    - if: $CONTAINER_SCANNING_DISABLED == 'true' || $CONTAINER_SCANNING_DISABLED == '1'
      when: never
    - if: $AST_ENABLE_MR_PIPELINES == "true" &&
          $CI_PIPELINE_SOURCE == "merge_request_event" &&
          $CI_GITLAB_FIPS_MODE == "true" &&
          $CS_ANALYZER_IMAGE !~ /-(fips|ubi)\z/
      variables:
        CS_IMAGE_SUFFIX: -fips
    - if: $AST_ENABLE_MR_PIPELINES == "true" &&
          $CI_PIPELINE_SOURCE == "merge_request_event"

    - if: $AST_ENABLE_MR_PIPELINES == "true" &&
          $CI_OPEN_MERGE_REQUESTS
      when: never
    - if: $CI_COMMIT_BRANCH &&
          $CI_GITLAB_FIPS_MODE == "true" &&
          $CS_ANALYZER_IMAGE !~ /-(fips|ubi)\z/
      variables:
        CS_IMAGE_SUFFIX: -fips
    - if: $CI_COMMIT_BRANCH

container_scanning_amd64:
  <<: *container_scanning_definition
  tags:
    - security
  variables:
    ARCH: amd64
    PLATFORM: amd64

container_scanning_armhf:
  <<: *container_scanning_definition
  tags:
    - security
  variables:
    ARCH: armhf
    PLATFORM: arm/v7

container_scanning_aarch64:
  <<: *container_scanning_definition
  tags:
    - security
  variables:
    ARCH: aarch64
    PLATFORM: arm64/v8

.sbom_template: &sbom_definition
  image: yobasystems/alpine:latest
  stage: test
  variables:
    GIT_STRATEGY: none
  before_script:
    - apk add --no-cache jq util-linux
  script:
    - |
      cat gl-sbom-report.cdx.json | jq -r '
        ["PACKAGE", "VERSION", "HASH (SHA-1)"],
        ["-------", "-------", "------------"],
        (.components[] | [.name, .version, (.hashes // [] | map(.content) | join(","))]),
        ["-------", "-------", "------------"],
        ["TOTAL PACKAGES:", ([.components[] | select(.type != "operating-system")] | length | tostring), ""]
      | @tsv' | column -t -s $'\t'
  rules:
    - if: $CONTAINER_SCANNING_DISABLED == 'true' || $CONTAINER_SCANNING_DISABLED == '1'
      when: never
    - if: $CI_COMMIT_BRANCH

sbom-amd64:
  <<: *sbom_definition
  tags:
    - security
  needs:
    - job: container_scanning_amd64
      artifacts: true
  variables:
    ARCH: amd64

sbom-armhf:
  <<: *sbom_definition
  tags:
    - security
  needs:
    - job: container_scanning_armhf
      artifacts: true
  variables:
    ARCH: armhf

sbom-aarch64:
  <<: *sbom_definition
  tags:
    - security
  needs:
    - job: container_scanning_aarch64
      artifacts: true
  variables:
    ARCH: aarch64
